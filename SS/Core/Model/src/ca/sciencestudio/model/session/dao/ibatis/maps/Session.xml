<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (c) Canadian Light Source, Inc. All rights reserved.
	see license.txt for details.
	
	Description:
		Session sql map xml file.	
 -->
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Session">
	<resultMap id="session" class="ca.sciencestudio.model.session.ibatis.IbatisSession">
		<result property="id" column="session_id" />
		<result property="name" column="name"/>
		<result property="description" column="description"/>
		<result property="proposal" column="proposal" />
		<result property="startDate" column="start_date" />
		<result property="endDate" column="end_date" />
		<result property="projectId" column="project_id" nullValue="0"/>
		<result property="laboratoryId" column="laboratory_id" nullValue="0"/>
	</resultMap>
	
	<insert id="addSession">
		INSERT INTO scstudio.session
		(
			name,
			description,
			proposal,
			start_date,
			end_date,
			project_id,
			laboratory_id
		) 
		VALUES
		(
			#name:VARCHAR#,
			#description:VARCHAR#,
			#proposal:VHARCHAR#,
			#startDate:DATETIME#,
			#endDate:DATETIME#,
			#projectId:INT#,
			#laboratoryId:INT#
		)
		<selectKey resultClass="java.lang.Integer" keyProperty="id">
			${identity.function}
		</selectKey>
	</insert>
	
	<update id="editSession">
		UPDATE scstudio.session
			SET
				name = #name:VARCHAR#,
				description = #description:VARCHAR#,
				proposal = #proposal:VARCHAR#,
				start_date = #startDate:DATETIME#,
				end_date = #endDate:DATETIME#,
				project_id = #projectId:INT#,
				laboratory_id = #laboratoryId:INT#
			WHERE
				session_id = #id:INT#
	</update>
	
	<delete id="removeSession">
		DELETE FROM scstudio.session
			WHERE session_id = #value#
	</delete>
	
	<select id="getSessionById" resultMap="session">
		SELECT *
			FROM scstudio.session 
			WHERE session_id = #value#
	</select>
	
	<select id="getSessionList" resultMap="session">
		SELECT *
			FROM scstudio.session
	</select>
	
	<select id="getSessionListByProjectId" resultMap="session">
		SELECT *
			FROM scstudio.session
			WHERE project_id = #value#
	</select>
	
	<select id="getSessionListByLaboratoryId" resultMap="session">
		SELECT *
			FROM scstudio.session
			WHERE laboratory_id = #value#
	</select>
	
	<select id="getSessionListByPersonUid" resultMap="session">
		SELECT s.session_id, s.name, s.description, s.project_id, s.proposal, s.laboratory_id, s.start_date, s.end_date
			FROM scstudio.session AS s, scstudio.project AS p, scstudio.project_person AS pp
			WHERE pp.person_uid = #value# AND pp.project_id = p.project_id AND p.project_id = s.project_id 
	</select>
	
	<select id="getSessionListByPersonUidAndProjectStatus" resultMap="session">
		SELECT s.session_id, s.name, s.description, s.project_id, s.proposal, s.laboratory_id, s.start_date, s.end_date
			FROM scstudio.session AS s, scstudio.project AS p, scstudio.project_person AS pp
			WHERE pp.person_uid = #param1# AND p.status = #param2# AND
					pp.project_id = p.project_id AND p.project_id = s.project_id 
	</select>
	
	<select id="getSessionListByLaboratoryNameAndFacilityName" resultMap="session">
		SELECT s.session_id, s.name, s.description, s.project_id, s.proposal, s.laboratory_id, s.start_date, s.end_date
			FROM scstudio.session AS s, scstudio.laboratory AS l, scstudio.facility AS f
			WHERE l.name LIKE #param1# AND f.name LIKE #param2# AND 
					l.facility_id = f.facility_id AND s.laboratory_id = l.laboratory_id
	</select>
	
</sqlMap>
